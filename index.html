<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIDCARE &copy; Capacity - Strategic Population Level</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    :root { --gap: 12px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: #111; }
    header { padding: 14px 16px; border-bottom: 1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img { height:42px; width:auto; }
    .brand h1 { margin: 0; font-size: 20px; letter-spacing: 0.2px; }
    .toolbar { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .toolbar button, .toolbar select {
      padding: 8px 10px; border: 1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04); font-weight:600;
    }
    .toolbar button:disabled { opacity: .5; cursor: default; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .controls {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: var(--gap); margin: 12px 0 16px;
    }
    .control { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .control label { display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px; }
    .control input[type=range] { width: 100%; }
    .control .val { font-variant-numeric: tabular-nums; font-size: 12px; color: #444; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 420px; gap: var(--gap); }
    .card { padding: 6px; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background: #fff; }
    .plotTitle { font-size: 14px; font-weight: 600; margin: 8px 6px 0 8px; color: #222; }
    #legendNote { margin: 8px 0 12px; font-size: 12px; color: #444; }
    .legendSwatch { display:inline-block; width:10px; height:10px; vertical-align:middle; margin-right:6px; border-radius:2px; }
    .red { background:#d62728; } .blue { background:#1f77b4; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; grid-auto-rows: 380px; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://assets.zyrosite.com/AoP61N2BR4i8Q6jl/logo-hsml-AE07eKDgMLFgWBoQ.png" alt="MIDCARE / HSML Logo">
      <h1>MIDCARE &copy; Capacity - Strategic Population Level</h1>
    </div>
    <div class="toolbar">
      <label for="endYear" style="font-weight:600;">End year</label>
      <select id="endYear" title="Select end year"></select>
      <button id="play">▶ Run</button>
      <button id="pause" disabled>⏸ Pause</button>
      <button id="reset">⟲ Reset</button>
      <span id="yearLabel" style="margin-left:8px;font-weight:600;">Selected year: 2065</span>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="control">
        <label>Population growth rate (annual)</label>
        <input id="popRate" type="range" min="0.0" max="0.02" step="0.0001" value="0.0074">
        <div class="val"><span id="popRateVal">0.74%</span> / yr</div>
      </div>
      <div class="control">
        <label>Consultant increase rate (annual)</label>
        <input id="consRate" type="range" min="0.0" max="0.06" step="0.0005" value="0.035">
        <div class="val"><span id="consRateVal">3.50%</span> / yr</div>
      </div>
      <div class="control">
        <label>Model 2 bed growth multiplier</label>
        <input id="bedRate2" type="range" min="0.5" max="1.5" step="0.001" value="0.999">
        <div class="val">× <span id="bedRate2Val">0.999</span></div>
      </div>
      <div class="control">
        <label>Model 4 bed growth rate (annual)</label>
        <input id="bedRate4" type="range" min="0.00" max="0.20" step="0.0005" value="0.099">
        <div class="val"><span id="bedRate4Val">9.90%</span> / yr</div>
      </div>
      <div class="control">
        <label>Optimal bed occupancy (fraction)</label>
        <input id="optOcc" type="range" min="0.70" max="0.95" step="0.005" value="0.85">
        <div class="val"><span id="optOccVal">0.85</span></div>
      </div>
      <div class="control">
        <label>Normal length of stay (days)</label>
        <input id="los" type="range" min="3" max="10" step="0.1" value="5">
        <div class="val"><span id="losVal">5.0</span> days</div>
      </div>
      <div class="control">
        <label>Normal specialist-to-bed ratio</label>
        <input id="normSpecBed" type="range" min="0.2" max="1.0" step="0.001" value="0.557">
        <div class="val"><span id="normSpecBedVal">0.557</span> people/(beds·days)</div>
      </div>
      <div class="control">
        <label>Normal bed-to-patient ratio</label>
        <input id="normBedPat" type="range" min="0.002" max="0.02" step="0.0001" value="0.0051">
        <div class="val"><span id="normBedPatVal">0.0051</span> beds/person</div>
      </div>
    </div>

    <div id="legendNote">
      <span class="legendSwatch red"></span>Historic to 2025 &nbsp;&nbsp;
      <span class="legendSwatch blue"></span>Projection from 2025 (animated)
    </div>

    <div class="grid">
      <div class="card">
        <div class="plotTitle">Population — Midwest</div>
        <div id="popPlot"></div>
      </div>
      <div class="card">
        <div class="plotTitle">Consultants — Headcount</div>
        <div id="consPlot"></div>
      </div>
      <div class="card">
        <div id="cap2Plot"></div>
      </div>
      <div class="card">
        <div id="cap4Plot"></div>
      </div>
    </div>
  </div>

<script>
(function() {
  // ---- Years ----
  const YEARS_ALL = Array.from({length: (2100 - 2009 + 1)}, (_, i) => 2009 + i);
  const YEARS_HIST = YEARS_ALL.filter(y => y <= 2025);

  // ---- Historic data ----
  const POP_H  = [361028,370177.5,379327,380496,381665,382834,384003,385172,389723.1667,394274.3333,398825.5,403376.6667,407927.8333,412479,412479,412479,412479];
  const CONS_H = [129,132,135,138,141,145,149,153,157,161,165,176,174,189.5,205,234,240];
  const CAP2_H = [179,179,175,172,189,185,177,178,167,186,187,184,184,184,184,184,184];
  const CAP4_H = [420,404,401,403,367,354,357,426,421,444,434,460,516,522.3333,528.6667,535,535];

  // ---- Defaults ----
  const DEFAULTS = {
    END_YEAR: 2065,
    POP_RATE: 0.0074,
    CONS_RATE: 0.035,
    BED_RATE2_MULT: 0.999,
    BED_RATE4: 0.099,
    OPT_OCC: 0.85,
    NORM_LOS: 5.0,
    NORM_SPEC_TO_BED: 0.557,
    NORM_BED_TO_PAT: 0.0051
  };

  // ---- Parameters (mutable) ----
  let END_YEAR = DEFAULTS.END_YEAR;
  let POP_RATE  = DEFAULTS.POP_RATE;
  let CONS_RATE = DEFAULTS.CONS_RATE;
  let BED_RATE2_MULT = DEFAULTS.BED_RATE2_MULT;
  let BED_RATE4 = DEFAULTS.BED_RATE4;
  let OPT_OCC = DEFAULTS.OPT_OCC;
  let NORM_LOS = DEFAULTS.NORM_LOS;
  let NORM_SPEC_TO_BED = DEFAULTS.NORM_SPEC_TO_BED;
  let NORM_BED_TO_PAT  = DEFAULTS.NORM_BED_TO_PAT;

  // ---- UI refs ----
  const $ = (id) => document.getElementById(id);
  const play = $("play");
  const pauseBtn = $("pause");
  const yearLabel = $("yearLabel");
  const endYearSel = $("endYear");

  // Populate end-year dropdown (2025..2100), set to default
  function populateEndYearOptions() {
    endYearSel.innerHTML = "";
    for (let y = 2025; y <= 2100; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      endYearSel.appendChild(opt);
    }
    endYearSel.value = String(DEFAULTS.END_YEAR);
  }
  populateEndYearOptions();

  const idxOfYear = (y) => YEARS_ALL.indexOf(y);

  // ---- Simulation (projects from 2025 onward) ----
  function simulateProjection() {
    const i2025 = YEARS_HIST.length - 1;
    const basePop = POP_H[i2025];
    const baseC   = CONS_H[i2025];
    const baseK2  = CAP2_H[i2025];
    const baseK4  = CAP4_H[i2025];

    const yearsProj = YEARS_ALL.slice(idxOfYear(2025));
    const pop = [basePop], cons = [baseC], k2 = [baseK2], k4 = [baseK4];

    for (let t = 1; t < yearsProj.length; t++) {
      const P  = pop[t-1];
      const C  = cons[t-1];
      const K2 = k2[t-1];
      const K4 = k4[t-1];

      const totalBedsDays = (K2 + K4) * 365;
      const patients = 0.194 * P + C * (413590.0/234.0);

      const m2_ratio = totalBedsDays > 0 ? (K2 * 365) / totalBedsDays : 0;
      const lengthOfStay = 1 + (NORM_LOS * m2_ratio);

      const required  = patients * lengthOfStay * 1.0;
      const occupied  = Math.min(required, totalBedsDays * OPT_OCC);
      const occupancy = totalBedsDays > 0 ? occupied / totalBedsDays : 0;
      const rate_effect1 = OPT_OCC - occupancy;

      const bedToPatientRatio = patients > 0 ? K4 / patients : 0;
      const rate_effect3 = BED_RATE4 * (bedToPatientRatio / NORM_BED_TO_PAT);

      const specToBed = totalBedsDays > 0 ? (C / Math.max(1,totalBedsDays)) * 1000 : 0;
      const current_effect2 = Math.max(0, Math.min(0.06, CONS_RATE * (specToBed / NORM_SPEC_TO_BED)));

      const dP  = POP_RATE * P;
      const dC  = C * current_effect2;

      const dK2 = (K2 < 800)  ? (K2 * Math.max(0.02035, rate_effect1) * BED_RATE2_MULT) : 0;
      const dK4 = (K4 < 1500) ? (K4 * Math.max(0.03, rate_effect3)) : 0;

      pop.push(P + dP);
      cons.push(C + dC);
      k2.push(K2 + dK2);
      k4.push(K4 + dK4);
    }
    return { yearsProj, pop, cons, k2, k4 };
  }

  // ---- Plot helpers ----
  function computeYRange(hist, projSlice) {
    const all = hist.concat(projSlice);
    const min = Math.min.apply(null, all);
    const max = Math.max.apply(null, all);
    const pad = (max - min) * 0.08 || 1;
    return [Math.max(0, min - pad), max + pad];
  }
  const cfg = { responsive:true, displaylogo:false };

  function mkLayout(yTitle, yRange, {xTitle="", chartTitle=""} = {}) {
    return {
      margin:{l:70,r:10,t:48,b:64},
      xaxis:{ title:{text:xTitle}, titlefont:{size:12}, title_standoff:12, automargin:true, range:[2009, END_YEAR] },
      yaxis:{ title:{text:yTitle}, automargin:true, range:yRange },
      title: chartTitle ? { text: chartTitle, x: 0, xanchor: "left", y: 0.98 } : undefined,
      showlegend:false
    };
  }

  // ---- Initial plots: red only ----
  function initialPlots() {
    const xHist = YEARS_HIST;

    Plotly.newPlot("popPlot",  [
      {x:xHist,y:POP_H,  mode:"lines", line:{color:"#d62728", width:2}}
    ], mkLayout("People", computeYRange(POP_H, [POP_H.at(-1)]), {xTitle:"Year"}), cfg);

    Plotly.newPlot("consPlot", [
      {x:xHist,y:CONS_H, mode:"lines", line:{color:"#d62728", width:2}}
    ], mkLayout("Consultants", computeYRange(CONS_H, [CONS_H.at(-1)]), {xTitle:"Year"}), cfg);

    Plotly.newPlot("cap2Plot", [
      {x:xHist,y:CAP2_H, mode:"lines", line:{color:"#d62728", width:2}}
    ], mkLayout("Model 2 Beds", computeYRange(CAP2_H, [CAP2_H.at(-1)]), {chartTitle:"Model 2 beds"}), cfg);

    Plotly.newPlot("cap4Plot", [
      {x:xHist,y:CAP4_H, mode:"lines", line:{color:"#d62728", width:2}}
    ], mkLayout("Model 4 Beds", computeYRange(CAP4_H, [CAP4_H.at(-1)]), {chartTitle:"Model 4 beds"}), cfg);
  }

  // ---- Animation (from 2025 to END_YEAR) ----
  let timer = null;
  const msPerFrame = 200;
  let proj = null;
  let frameIdx = 0; // 0 => year 2025

  function addBlueTracesIfMissing() {
    const addIf = (divId, y0) => {
      const gd = document.getElementById(divId);
      if (gd.data.length === 1) {
        Plotly.addTraces(divId, {x:[2025], y:[y0], mode:"lines", line:{color:"#1f77b4", width:3}});
      }
    };
    addIf("popPlot",  POP_H.at(-1));
    addIf("consPlot", CONS_H.at(-1));
    addIf("cap2Plot", CAP2_H.at(-1));
    addIf("cap4Plot", CAP4_H.at(-1));
  }

  function renderFrame(i) {
    const years = proj.yearsProj.slice(0, i+1); // 2025.. up to current
    const yrPop  = computeYRange(POP_H,  proj.pop.slice(0, i+1));
    const yrCons = computeYRange(CONS_H, proj.cons.slice(0, i+1));
    const yrK2   = computeYRange(CAP2_H, proj.k2.slice(0, i+1));
    const yrK4   = computeYRange(CAP4_H, proj.k4.slice(0, i+1));

    Plotly.restyle("popPlot",  {x:[YEARS_HIST, years], y:[POP_H,  proj.pop.slice(0,i+1)]});
    Plotly.relayout("popPlot", { "yaxis.range": yrPop, "xaxis.range":[2009, END_YEAR] });

    Plotly.restyle("consPlot", {x:[YEARS_HIST, years], y:[CONS_H, proj.cons.slice(0,i+1)]});
    Plotly.relayout("consPlot", { "yaxis.range": yrCons, "xaxis.range":[2009, END_YEAR] });

    Plotly.restyle("cap2Plot",{x:[YEARS_HIST, years], y:[CAP2_H, proj.k2.slice(0,i+1)]});
    Plotly.relayout("cap2Plot",{ "yaxis.range": yrK2, "xaxis.range":[2009, END_YEAR] });

    Plotly.restyle("cap4Plot",{x:[YEARS_HIST, years], y:[CAP4_H, proj.k4.slice(0,i+1)]});
    Plotly.relayout("cap4Plot",{ "yaxis.range": yrK4, "xaxis.range":[2009, END_YEAR] });

    yearLabel.textContent = "Selected year: " + years.at(-1);
  }

  function start() {
    play.disabled = true; 
    pauseBtn.disabled = false;

    proj = simulateProjection();
    addBlueTracesIfMissing();

    frameIdx = 0;
    renderFrame(frameIdx);

    if (timer) clearInterval(timer);
    timer = setInterval(() => {
      frameIdx += 1;
      const maxFrames = (END_YEAR - 2025);
      if (frameIdx > maxFrames) { pause(); return; }
      renderFrame(frameIdx);
    }, msPerFrame);
  }

  function pause() { 
    play.disabled = false; 
    pauseBtn.disabled = true; 
    if (timer) clearInterval(timer); 
    timer = null; 
  }

  // ---- Reset to defaults ----
  function reset() {
    // stop animation
    pause();

    // restore parameters
    END_YEAR           = DEFAULTS.END_YEAR;
    POP_RATE           = DEFAULTS.POP_RATE;
    CONS_RATE          = DEFAULTS.CONS_RATE;
    BED_RATE2_MULT     = DEFAULTS.BED_RATE2_MULT;
    BED_RATE4          = DEFAULTS.BED_RATE4;
    OPT_OCC            = DEFAULTS.OPT_OCC;
    NORM_LOS           = DEFAULTS.NORM_LOS;
    NORM_SPEC_TO_BED   = DEFAULTS.NORM_SPEC_TO_BED;
    NORM_BED_TO_PAT    = DEFAULTS.NORM_BED_TO_PAT;

    // restore sliders & value labels
    $("popRate").value      = String(POP_RATE);
    $("consRate").value     = String(CONS_RATE);
    $("bedRate2").value     = String(BED_RATE2_MULT);
    $("bedRate4").value     = String(BED_RATE4);
    $("optOcc").value       = String(OPT_OCC);
    $("los").value          = String(NORM_LOS);
    $("normSpecBed").value  = String(NORM_SPEC_TO_BED);
    $("normBedPat").value   = String(NORM_BED_TO_PAT);

    $("popRateVal").textContent     = (POP_RATE*100).toFixed(2) + "%";
    $("consRateVal").textContent    = (CONS_RATE*100).toFixed(2) + "%";
    $("bedRate2Val").textContent    = BED_RATE2_MULT.toFixed(3);
    $("bedRate4Val").textContent    = (BED_RATE4*100).toFixed(2) + "%";
    $("optOccVal").textContent      = OPT_OCC.toFixed(2);
    $("losVal").textContent         = NORM_LOS.toFixed(1);
    $("normSpecBedVal").textContent = NORM_SPEC_TO_BED.toFixed(3);
    $("normBedPatVal").textContent  = NORM_BED_TO_PAT.toFixed(4);

    // restore dropdown
    endYearSel.value = String(DEFAULTS.END_YEAR);

    // restore label
    yearLabel.textContent = "Selected year: " + DEFAULTS.END_YEAR;

    // recalc projection and redraw RED ONLY (clean state)
    proj = simulateProjection();
    frameIdx = 0;
    initialPlots();
  }

  // ---- Sliders bind ----
  function updateParams() {
    POP_RATE         = parseFloat($("popRate").value);
    CONS_RATE        = parseFloat($("consRate").value);
    BED_RATE2_MULT   = parseFloat($("bedRate2").value);
    BED_RATE4        = parseFloat($("bedRate4").value);
    OPT_OCC          = parseFloat($("optOcc").value);
    NORM_LOS         = parseFloat($("los").value);
    NORM_SPEC_TO_BED = parseFloat($("normSpecBed").value);
    NORM_BED_TO_PAT  = parseFloat($("normBedPat").value);

    $("popRateVal").textContent     = (POP_RATE*100).toFixed(2) + "%";
    $("consRateVal").textContent    = (CONS_RATE*100).toFixed(2) + "%";
    $("bedRate2Val").textContent    = BED_RATE2_MULT.toFixed(3);
    $("bedRate4Val").textContent    = (BED_RATE4*100).toFixed(2) + "%";
    $("optOccVal").textContent      = OPT_OCC.toFixed(2);
    $("losVal").textContent         = NORM_LOS.toFixed(1);
    $("normSpecBedVal").textContent = NORM_SPEC_TO_BED.toFixed(3);
    $("normBedPatVal").textContent  = NORM_BED_TO_PAT.toFixed(4);

    // reset view to red-only until next Run
    proj = simulateProjection();
    frameIdx = 0;
    pause();
    yearLabel.textContent = "Selected year: " + END_YEAR;
    initialPlots();
  }
  ["popRate","consRate","bedRate2","bedRate4","optOcc","los","normSpecBed","normBedPat"].forEach(id => {
    $(id).addEventListener("input", updateParams);
    $(id).addEventListener("change", updateParams);
  });

  // ---- End year change ----
  endYearSel.addEventListener("change", () => {
    END_YEAR = parseInt(endYearSel.value, 10);
    frameIdx = 0;
    pause();
    yearLabel.textContent = "Selected year: " + END_YEAR;
    initialPlots();
  });

  // ---- Init ----
  initialPlots();                       // red historic only on load
  yearLabel.textContent = "Selected year: " + DEFAULTS.END_YEAR;

  // ---- Buttons ----
  play.addEventListener("click", start);
  pauseBtn.addEventListener("click", pause);
  $("reset").addEventListener("click", reset);
})();
</script>
</body>
</html>

